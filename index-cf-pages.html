<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beacon Bitcoin Treasury Dashboard — v1 (Cloudflare Pages)</title>
  <meta name="description" content="Beacon Bitcoin Treasury Dashboard — simulate BTC / MSTR / MSTY allocations with real historical data." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9A%A1%EF%B8%8F%3C/text%3E%3C/svg%3E"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { beacon: { bg: '#0b0b0d', card: '#111113', gold: '#d4af37', accent: '#f7931a' } },
          boxShadow: { soft: '0 8px 24px rgba(0,0,0,0.35)' },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { scrollbar-width: thin; scrollbar-color: #333 #0b0b0d; }
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-track { background: #0b0b0d; }
    *::-webkit-scrollbar-thumb { background-color: #333; border-radius: 6px; border: 2px solid #0b0b0d; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); }
    .glass { backdrop-filter: blur(6px); }
    .num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="h-full bg-beacon-bg text-white">
  <header class="sticky top-0 z-30 bg-black/40 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-beacon-accent to-beacon-gold grid place-items-center shadow-soft"><span class="text-black font-black">B</span></div>
        <div>
          <h1 class="text-lg md:text-xl font-semibold">Beacon Bitcoin Treasury — Dashboard</h1>
          <p class="text-xs text-white/60 -mt-0.5">Educate · Simulate · Stress-test — without financial advice</p>
        </div>
      </div>
      <a id="ctaLink" href="https://bitcointreasurysystem.com/" class="inline-flex items-center gap-2 rounded-2xl bg-beacon-accent text-black font-semibold px-4 py-2 shadow-soft hover:scale-[1.02] transition">
        Book Discovery Call
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid md:grid-cols-12 gap-6">
    <section class="md:col-span-4 space-y-6">
      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">1) Dates & Allocations</h2>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs text-white/60 mb-1">Start Date</label><input id="startDate" type="date" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
          <div><label class="block text-xs text-white/60 mb-1">End Date</label><input id="endDate" type="date" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-3">
          <div><label class="block text-xs text-white/60 mb-1">BTC %</label><input id="allocBTC" type="number" value="60" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
          <div><label class="block text-xs text-white/60 mb-1">MSTR %</label><input id="allocMSTR" type="number" value="30" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
          <div><label class="block text-xs text-white/60 mb-1">MSTY %</label><input id="allocMSTY" type="number" value="10" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
        </div>
        <p class="text-xs text-white/50 mt-2">Allocations must sum to 100%.</p>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">2) Capital & DCA</h2>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs text-white/60 mb-1">Starting Capital (USD)</label><input id="startCapital" type="number" value="100000" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
          <div><label class="block text-xs text-white/60 mb-1">Monthly DCA (USD)</label><input id="monthlyDca" type="number" value="25000" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/></div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="runBtn" class="flex-1 rounded-2xl bg-white text-black font-semibold px-4 py-2 hover:bg-white/90">Run Simulation</button>
          <button id="resetBtn" class="rounded-2xl bg-black border border-white/20 px-4 py-2">Reset</button>
        </div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">3) Stress Test (instant shock)</h2>
        <div class="space-y-4">
          <div><label class="block text-xs text-white/60">BTC Shock (%)</label><input id="shockBTC" type="range" min="-80" max="300" value="0" class="w-full"/><div class="text-xs text-white/50"><span id="shockBTCVal">0</span>%</div></div>
          <div><label class="block text-xs text-white/60">MSTR Shock (%)</label><input id="shockMSTR" type="range" min="-80" max="300" value="0" class="w-full"/><div class="text-xs text-white/50"><span id="shockMSTRVal">0</span>%</div></div>
          <div><label class="block text-xs text-white/60">MSTY Shock (%)</label><input id="shockMSTY" type="range" min="-80" max="300" value="0" class="w-full"/><div class="text-xs text-white/50"><span id="shockMSTYVal">0</span>%</div></div>
        </div>
        <p class="text-xs text-white/50 mt-2">Applies a one-time shock to the latest prices to illustrate immediate portfolio impact.</p>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-3">Exports</h2>
        <div class="flex gap-2">
          <button id="csvBtn" class="rounded-2xl bg-beacon-accent text-black font-semibold px-4 py-2">Download CSV</button>
          <button id="pngBtn" class="rounded-2xl bg-black border border-white/20 px-4 py-2">Download Chart PNG</button>
        </div>
      </div>
    </section>

    <section class="md:col-span-8 space-y-6">
      <div class="grid sm:grid-cols-3 gap-4">
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">BTC (USD)</div><div id="btcPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div><div id="btcChange" class="text-xs text-white/60">24h: —</div></div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">MSTR (USD)</div><div id="mstrPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div><div id="mstrChange" class="text-xs text-white/60">% from start: —</div></div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">MSTY (USD)</div><div id="mstyPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div><div id="mstyChange" class="text-xs text-white/60">% from start: —</div></div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <div class="flex items-end justify-between gap-4">
          <div><h2 class="text-base font-semibold">Portfolio Growth</h2><p class="text-xs text-white/60">Value over time with monthly DCA and chosen allocations.</p></div>
          <div class="text-right"><div class="text-xs text-white/60">Final Value</div><div id="finalValue" class="text-xl font-semibold num">—</div></div>
        </div>
        <div class="h-64 sm:h-80"><canvas id="chart" class="mt-4"></canvas></div>
      </div>

      <div class="grid sm:grid-cols-4 gap-4">
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">CAGR</div><div id="cagr" class="text-xl font-semibold num mt-1">—</div></div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">Max Drawdown</div><div id="mdd" class="text-xl font-semibold num mt-1">—</div></div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">Volatility (ann.)</div><div id="vol" class="text-xl font-semibold num mt-1">—</div></div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft"><div class="text-xs text-white/60">Sharpe (rf=0%)</div><div id="sharpe" class="text-xl font-semibold num mt-1">—</div></div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-2">Notes</h2>
        <ul class="list-disc list-inside text-sm text-white/70 space-y-1">
          <li>BTC via CoinGecko (no key). MSTR & MSTY via Yahoo Finance through a Cloudflare Pages Function (free).</li>
          <li>This tool is educational and informational only. It is <span class="font-semibold">not financial advice</span>.</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // Use the function on the same origin (Cloudflare Pages): /yahoo
    const YAHOO_PROXY = '/yahoo';

    // ====== Utilities ======
    const $ = (id) => document.getElementById(id);
    const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const fmtPct = (x, digits=2) => (isFinite(x) ? (x*100).toFixed(digits)+'%' : '—');
    const toISODate = (d) => d.toISOString().slice(0,10);
    function monthDiff(d1, d2){ let m=(d2.getFullYear()-d1.getFullYear())*12; m+=d2.getMonth()-d1.getMonth(); return Math.max(0,m); }
    function maxDrawdown(series){ let peak=-Infinity,mdd=0; for(const v of series){ peak=Math.max(peak,v); mdd=Math.min(mdd,(v-peak)/peak);} return Math.abs(mdd); }
    function annualizedVol(returns,ppy=252){ const mean=returns.reduce((a,b)=>a+b,0)/returns.length; const variance=returns.reduce((a,b)=>a+(b-mean)*(b-mean),0)/(returns.length-1||1); return Math.sqrt(variance*ppy); }
    function sharpe(returns,rf=0,ppy=252){ const mean=returns.reduce((a,b)=>a+b,0)/returns.length; const vol=annualizedVol(returns,ppy); return vol? (mean*ppy-rf)/vol:0; }
    function csvDownload(filename, rows){ const csv=rows.map(r=>r.map(x=>x==null?'':String(x)).join(',')).join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

    (function initDates(){ const end=new Date(); const start=new Date(end); start.setFullYear(end.getFullYear()-5); $('startDate').value=toISODate(start); $('endDate').value=toISODate(end); })();

    async function fetchBTCSeries(start,end){
      const from=Math.floor(start.getTime()/1000), to=Math.floor(end.getTime()/1000);
      const url=`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${from}&to=${to}`;
      const res=await fetch(url); if(!res.ok) throw new Error('BTC fetch failed');
      const data=await res.json();
      const daily=data.prices.map(([ms,p])=>({date:toISODate(new Date(ms)), close:p}));
      const map=new Map(); for(const d of daily) map.set(d.date,d.close);
      return Array.from(map.entries()).map(([date,close])=>({date,close})).sort((a,b)=>a.date.localeCompare(b.date));
    }

    async function fetchYahooSeries(symbol){
      const url = `${YAHOO_PROXY}?symbol=${encodeURIComponent(symbol)}`;
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error(symbol + ' fetch failed');
      const json = await res.json();
      const result = json?.chart?.result?.[0];
      if (!result) throw new Error(symbol + ' fetch failed');
      const timestamps = result.timestamp || [];
      const closes = result.indicators?.quote?.[0]?.close || [];
      const out = [];
      for (let i=0;i<timestamps.length;i++){
        const c = closes[i];
        if (c == null) continue;
        const date = toISODate(new Date(timestamps[i]*1000));
        out.push({ date, close: Number(c) });
      }
      return out.sort((a,b)=>a.date.localeCompare(b.date));
    }

    let chart;
    async function runSimulation(){
      try{
        const start=new Date($('startDate').value);
        const end=new Date($('endDate').value);
        if(end<=start) throw new Error('End date must be after start date');

        const allocs={ BTC:Number($('allocBTC').value)/100, MSTR:Number($('allocMSTR').value)/100, MSTY:Number($('allocMSTY').value)/100 };
        if(Math.abs(allocs.BTC+allocs.MSTR+allocs.MSTY-1)>1e-6) throw new Error('Allocations must sum to 100%');

        const [btcAll,mstrAll,mstyAll]=await Promise.all([
          fetchBTCSeries(start,end), fetchYahooSeries('MSTR'), fetchYahooSeries('MSTY')
        ]);

        const inRange=(r)=> r.date>=toISODate(start) && r.date<=toISODate(end);
        const BTC=btcAll.filter(inRange), MSTR=mstrAll.filter(inRange), MSTY=mstyAll.filter(inRange);

        const dates=[...new Set([...BTC.map(d=>d.date),...MSTR.map(d=>d.date),...MSTY.map(d=>d.date)])].sort();
        const series=dates.map(date=>({ date, BTC:BTC.find(d=>d.date===date)?.close??null, MSTR:MSTR.find(d=>d.date===date)?.close??null, MSTY:MSTY.find(d=>d.date===date)?.close??null })).filter(r=>r.BTC&&r.MSTR&&r.MSTY);
        if(!series.length) throw new Error('No overlapping data in chosen window. Try widening dates.');

        const last=series[series.length-1];
        $('btcPrice').textContent=fmtUSD.format(last.BTC);
        $('mstrPrice').textContent=fmtUSD.format(last.MSTR);
        $('mstyPrice').textContent=fmtUSD.format(last.MSTY);

        const first=series[0];
        $('mstrChange').textContent=`% from start: ${((last.MSTR/first.MSTR-1)*100).toFixed(2)}%`;
        $('mstyChange').textContent=`% from start: ${((last.MSTY/first.MSTY-1)*100).toFixed(2)}%`;

        try{ const btc24=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true').then(r=>r.json()); const ch=btc24.bitcoin.usd_24h_change/100; $('btcChange').textContent=`24h: ${fmtPct(ch)}`; }catch{}

        const startCapital=Number($('startCapital').value);
        const monthlyDca=Number($('monthlyDca').value);
        const months=monthDiff(new Date(series[0].date), new Date(series[series.length-1].date))+1;

        let units={BTC:0,MSTR:0,MSTY:0};
        units.BTC+=(startCapital*allocs.BTC)/series[0].BTC;
        units.MSTR+=(startCapital*allocs.MSTR)/series[0].MSTR;
        units.MSTY+=(startCapital*allocs.MSTY)/series[0].MSTY;

        const monthStartSet=new Set(); series.forEach(r=>{ const d=new Date(r.date); if(d.getDate()===1) monthStartSet.add(r.date); });

        const portVals=[], dailyReturns=[]; let prevVal=null;
        for (const row of series){
          const isMonthStart=monthStartSet.has(row.date) && row.date!==series[0].date;
          if(isMonthStart && monthlyDca>0){ units.BTC+=(monthlyDca*allocs.BTC)/row.BTC; units.MSTR+=(monthlyDca*allocs.MSTR)/row.MSTR; units.MSTY+=(monthlyDca*allocs.MSTY)/row.MSTY; }
          const value=units.BTC*row.BTC + units.MSTR*row.MSTR + units.MSTY*row.MSTY;
          portVals.push({date:row.date, value});
          if(prevVal!=null) dailyReturns.push((value/prevVal)-1);
          prevVal=value;
        }

        const finalVal=portVals[portVals.length-1].value;
        $('finalValue').textContent=fmtUSD.format(finalVal);

        const years=(new Date(series[series.length-1].date)-new Date(series[0].date))/(365.25*24*3600*1000);
        const totalContribs=startCapital + monthlyDca*(months-1);
        $('cagr').textContent=fmtPct(Math.pow(finalVal/Math.max(1,totalContribs), 1/Math.max(0.0001,years)) - 1);
        $('mdd').textContent=fmtPct(maxDrawdown(portVals.map(p=>p.value)));
        $('vol').textContent=fmtPct(annualizedVol(dailyReturns));
        $('sharpe').textContent=isFinite(sharpe(dailyReturns,0))?sharpe(dailyReturns,0).toFixed(2):'—';

        const ctx=document.getElementById('chart').getContext('2d');
        if(window.__chart) window.__chart.destroy();
        window.__chart=new Chart(ctx,{type:'line',data:{labels:portVals.map(d=>d.date),datasets:[{label:'Portfolio Value (USD)',data:portVals.map(d=>d.value),borderWidth:2,tension:0.25,pointRadius:0}]},options:{animation:{duration:400},maintainAspectRatio:false,scales:{x:{ticks:{color:'#aaa'},grid:{color:'rgba(255,255,255,0.06)'}},y:{ticks:{color:'#aaa',callback:v=>'$'+Intl.NumberFormat('en-US').format(v)},grid:{color:'rgba(255,255,255,0.06)'}}},plugins:{legend:{labels:{color:'#ddd'}},tooltip:{callbacks:{label:ctx=>fmtUSD.format(ctx.parsed.y)}}}});

        window.__beacon_export_rows=[['date','portfolio_value_usd'], ...portVals.map(r=>[r.date, r.value.toFixed(2)])];
      }catch(err){ alert(err.message || String(err)); }
    }

    document.getElementById('runBtn').addEventListener('click', runSimulation);
    document.getElementById('resetBtn').addEventListener('click', ()=>window.location.reload());
    document.getElementById('csvBtn').addEventListener('click', ()=>{ if(!window.__beacon_export_rows) return alert('Run a simulation first.'); csvDownload('beacon_portfolio.csv', window.__beacon_export_rows); });
    document.getElementById('pngBtn').addEventListener('click', ()=>{ if(!window.__chart) return alert('Run a simulation first.'); const url=window.__chart.toBase64Image('image/png',1); const a=document.createElement('a'); a.href=url; a.download='beacon_chart.png'; a.click(); });
  </script>
</body>
</html>
