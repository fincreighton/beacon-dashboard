<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beacon Bitcoin Treasury Dashboard — v1</title>
  <meta name="description" content="Beacon Bitcoin Treasury Dashboard — simulate BTC / MSTR / MSTY allocations with real historical data." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9A%A1%EF%B8%8F%3C/text%3E%3C/svg%3E"/>

  <!-- Tailwind (CDN mode for quick start) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            beacon: {
              bg: '#0b0b0d',
              card: '#111113',
              gold: '#d4af37',
              accent: '#f7931a' // Bitcoin orange
            }
          },
          boxShadow: {
            soft: '0 8px 24px rgba(0,0,0,0.35)'
          },
          borderRadius: {
            xl2: '1.25rem'
          }
        }
      }
    }
  </script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { scrollbar-width: thin; scrollbar-color: #333 #0b0b0d; }
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-track { background: #0b0b0d; }
    *::-webkit-scrollbar-thumb { background-color: #333; border-radius: 6px; border: 2px solid #0b0b0d; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); }
    .glass { backdrop-filter: blur(6px); }
    .num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="h-full bg-beacon-bg text-white">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-black/40 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-beacon-accent to-beacon-gold grid place-items-center shadow-soft">
          <span class="text-black font-black">B</span>
        </div>
        <div>
          <h1 class="text-lg md:text-xl font-semibold">Beacon Bitcoin Treasury — Dashboard</h1>
          <p class="text-xs text-white/60 -mt-0.5">Educate · Simulate · Stress‑test — without financial advice</p>
        </div>
      </div>
      <a id="ctaLink" href="https://bitcointreasurysystem.com/" class="inline-flex items-center gap-2 rounded-2xl bg-beacon-accent text-black font-semibold px-4 py-2 shadow-soft hover:scale-[1.02] transition">
        Book Discovery Call
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </a>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 grid md:grid-cols-12 gap-6">
    <!-- Controls panel -->
    <section class="md:col-span-4 space-y-6">
      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">1) Data & Keys</h2>
        <label class="block text-sm text-white/70 mb-1">Alpha Vantage API Key <span class="text-white/40">(for MSTR & MSTY)</span></label>
        <input id="alphaKey" type="password" placeholder="Paste your key…" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-beacon-accent/60"/>
        <p class="text-xs text-white/50 mt-1">Get a free key at <a class="underline" href="https://www.alphavantage.co/support/#api-key" target="_blank">Alpha Vantage</a>. Stored locally only.</p>
        <div class="mt-3 flex items-center gap-2">
          <input id="saveKey" type="checkbox" class="accent-beacon-accent" />
          <label for="saveKey" class="text-sm text-white/70">Remember key on this device</label>
        </div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">2) Portfolio Inputs</h2>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-white/60 mb-1">Starting Capital (USD)</label>
            <input id="startCapital" type="number" value="100000" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">Monthly DCA (USD)</label>
            <input id="monthlyDca" type="number" value="25000" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">Start Date</label>
            <input id="startDate" type="date" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">End Date</label>
            <input id="endDate" type="date" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-3">
          <div>
            <label class="block text-xs text-white/60 mb-1">BTC %</label>
            <input id="allocBTC" type="number" value="60" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">MSTR %</label>
            <input id="allocMSTR" type="number" value="30" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
          <div>
            <label class="block text-xs text-white/60 mb-1">MSTY %</label>
            <input id="allocMSTY" type="number" value="10" min="0" max="100" class="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2"/>
          </div>
        </div>
        <p class="text-xs text-white/50 mt-2">Allocations must sum to 100%.</p>

        <div class="mt-4 flex gap-2">
          <button id="runBtn" class="flex-1 rounded-2xl bg-white text-black font-semibold px-4 py-2 hover:bg-white/90">Run Simulation</button>
          <button id="resetBtn" class="rounded-2xl bg-black border border-white/20 px-4 py-2">Reset</button>
        </div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-4">3) Stress Test (instant shock)</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-xs text-white/60">BTC Shock (%)</label>
            <input id="shockBTC" type="range" min="-80" max="300" value="0" class="w-full"/>
            <div class="text-xs text-white/50"><span id="shockBTCVal">0</span>%</div>
          </div>
          <div>
            <label class="block text-xs text-white/60">MSTR Shock (%)</label>
            <input id="shockMSTR" type="range" min="-80" max="300" value="0" class="w-full"/>
            <div class="text-xs text-white/50"><span id="shockMSTRVal">0</span>%</div>
          </div>
          <div>
            <label class="block text-xs text-white/60">MSTY Shock (%)</label>
            <input id="shockMSTY" type="range" min="-80" max="300" value="0" class="w-full"/>
            <div class="text-xs text-white/50"><span id="shockMSTYVal">0</span>%</div>
          </div>
        </div>
        <p class="text-xs text-white/50 mt-2">Applies a one‑time shock to the latest prices to illustrate immediate portfolio impact.</p>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-3">Exports</h2>
        <div class="flex gap-2">
          <button id="csvBtn" class="rounded-2xl bg-beacon-accent text-black font-semibold px-4 py-2">Download CSV</button>
          <button id="pngBtn" class="rounded-2xl bg-black border border-white/20 px-4 py-2">Download Chart PNG</button>
        </div>
      </div>
    </section>

    <!-- Dashboard panel -->
    <section class="md:col-span-8 space-y-6">
      <div class="grid sm:grid-cols-3 gap-4">
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">BTC (USD)</div>
          <div id="btcPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div>
          <div id="btcChange" class="text-xs text-white/60">24h: —</div>
        </div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">MSTR (USD)</div>
          <div id="mstrPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div>
          <div id="mstrChange" class="text-xs text-white/60">% from start: —</div>
        </div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">MSTY (USD)</div>
          <div id="mstyPrice" class="text-2xl md:text-3xl font-semibold num mt-1">—</div>
          <div id="mstyChange" class="text-xs text-white/60">% from start: —</div>
        </div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <div class="flex items-end justify-between gap-4">
          <div>
            <h2 class="text-base font-semibold">Portfolio Growth</h2>
            <p class="text-xs text-white/60">Value over time with monthly DCA and chosen allocations.</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-white/60">Final Value</div>
            <div id="finalValue" class="text-xl font-semibold num">—</div>
          </div>
        </div>
        <canvas id="chart" class="mt-4"></canvas>
      </div>

      <div class="grid sm:grid-cols-4 gap-4">
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">CAGR</div>
          <div id="cagr" class="text-xl font-semibold num mt-1">—</div>
        </div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">Max Drawdown</div>
          <div id="mdd" class="text-xl font-semibold num mt-1">—</div>
        </div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">Volatility (ann.)</div>
          <div id="vol" class="text-xl font-semibold num mt-1">—</div>
        </div>
        <div class="card rounded-xl2 p-4 border border-white/10 shadow-soft">
          <div class="text-xs text-white/60">Sharpe (rf=0%)</div>
          <div id="sharpe" class="text-xl font-semibold num mt-1">—</div>
        </div>
      </div>

      <div class="card rounded-xl2 p-5 border border-white/10 shadow-soft">
        <h2 class="text-base font-semibold mb-2">Notes</h2>
        <ul class="list-disc list-inside text-sm text-white/70 space-y-1">
          <li>BTC data via CoinGecko with automatic fallback to Alpha Vantage if CoinGecko is unavailable.</li>
          <li>MSTR & MSTY via Alpha Vantage (free tier; ~5 calls/min). Data shown is daily adjusted close.</li>
          <li>This tool is educational and informational only. It is <span class="font-semibold">not financial advice</span>.</li>
        </ul>
      </div>
    </section>
  </main>

  <script>
    // ====== Utilities ======
    const $ = (id) => document.getElementById(id);
    const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const fmtPct = (x, digits=2) => (isFinite(x) ? (x*100).toFixed(digits)+'%' : '—');

    function toISODate(d) { return d.toISOString().slice(0,10); }

    function monthDiff(d1, d2) {
      let months = (d2.getFullYear() - d1.getFullYear()) * 12;
      months += d2.getMonth() - d1.getMonth();
      return Math.max(0, months);
    }

    function maxDrawdown(series) {
      let peak = -Infinity, mdd = 0;
      for (const v of series) {
        peak = Math.max(peak, v);
        mdd = Math.min(mdd, (v - peak) / peak);
      }
      return Math.abs(mdd);
    }

    function annualizedVol(returns, periodsPerYear=252) {
      const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
      const variance = returns.reduce((a,b)=> a + (b-mean)*(b-mean), 0) / (returns.length-1 || 1);
      return Math.sqrt(variance * periodsPerYear);
    }

    function sharpe(returns, rf=0, periodsPerYear=252) {
      const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
      const vol = annualizedVol(returns, periodsPerYear);
      return vol ? (mean*periodsPerYear - rf) / vol : 0;
    }

    function csvDownload(filename, rows) {
      const process = r => r.map(x => (x==null ? '' : String(x))).join(',');
      const csv = rows.map(process).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ====== Defaults for date inputs ======
    (function initDates(){
      const end = new Date();
      const start = new Date(end); start.setFullYear(end.getFullYear() - 5);
      $('startDate').value = toISODate(start);
      $('endDate').value = toISODate(end);
      const saved = localStorage.getItem('beacon_alpha_key');
      if (saved) { $('alphaKey').value = saved; $('saveKey').checked = true; }
    })();

    // ====== Data Fetchers ======
    async function fetchBTCSeries(start, end, alphaKey) {
      // Try CoinGecko first
      try {
        const from = Math.floor(start.getTime()/1000);
        const to = Math.floor(end.getTime()/1000);
        const url = `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${from}&to=${to}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('coingecko-fail');
        const data = await res.json();
        const daily = data.prices.map(([ms, p]) => ({ date: toISODate(new Date(ms)), close: p }));
        const map = new Map();
        for (const d of daily) map.set(d.date, d.close);
        return Array.from(map.entries()).map(([date, close]) => ({ date, close })).sort((a,b)=>a.date.localeCompare(b.date));
      } catch (e) {
        // Fallback: Alpha Vantage DIGITAL_CURRENCY_DAILY
        if (!alphaKey) throw new Error('BTC fetch failed (no API key for fallback)');
        const url = `https://www.alphavantage.co/query?function=DIGITAL_CURRENCY_DAILY&symbol=BTC&market=USD&apikey=${alphaKey}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('BTC fetch failed');
        const json = await res.json();
        const ts = json['Time Series (Digital Currency Daily)'];
        if (!ts) throw new Error('BTC fetch failed');
        const out = Object.entries(ts).map(([date, o]) => ({ date, close: parseFloat(o['4a. close (USD)']) }));
        return out.sort((a,b)=> a.date.localeCompare(b.date));
      }
    }

    async function fetchAlphaSeries(symbol, key) {
      const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&outputsize=full&apikey=${key}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(symbol + ' fetch failed');
      const json = await res.json();
      const ts = json['Time Series (Daily)'];
      if (!ts) throw new Error('Alpha Vantage limit or invalid key (no time series)');
      const out = Object.entries(ts).map(([date, o]) => ({ date, close: parseFloat(o['5. adjusted close']) }));
      return out.sort((a,b)=> a.date.localeCompare(b.date));
    }

    // ====== Core Simulation ======
    async function runSimulation() {
      try {
        const start = new Date($('startDate').value);
        const end = new Date($('endDate').value);
        if (end <= start) throw new Error('End date must be after start date');

        const allocs = {
          BTC: Number($('allocBTC').value)/100,
          MSTR: Number($('allocMSTR').value)/100,
          MSTY: Number($('allocMSTY').value)/100,
        };
        const sumAlloc = allocs.BTC + allocs.MSTR + allocs.MSTY;
        if (Math.abs(sumAlloc - 1) > 1e-6) throw new Error('Allocations must sum to 100%');

        const startCapital = Number($('startCapital').value);
        const monthlyDca = Number($('monthlyDca').value);
        if (startCapital < 0 || monthlyDca < 0) throw new Error('Capital and DCA must be non‑negative');

        const alphaKey = $('alphaKey').value.trim();
        if ($('saveKey').checked && alphaKey) localStorage.setItem('beacon_alpha_key', alphaKey); else localStorage.removeItem('beacon_alpha_key');

        // Fetch data in parallel
        const [btc, mstr, msty] = await Promise.all([
          fetchBTCSeries(start, end, alphaKey),
          fetchAlphaSeries('MSTR', alphaKey),
          fetchAlphaSeries('MSTY', alphaKey)
        ]);

        // Slice to date range
        const inRange = (row) => (row.date >= toISODate(start) && row.date <= toISODate(end));
        const BTC = btc.filter(inRange);
        const MSTR = mstr.filter(inRange);
        const MSTY = msty.filter(inRange);

        // Align by date
        const dates = [...new Set([...BTC.map(d=>d.date), ...MSTR.map(d=>d.date), ...MSTY.map(d=>d.date)])].sort();
        const series = dates.map(date => ({
          date,
          BTC: BTC.find(d=>d.date===date)?.close ?? null,
          MSTR: MSTR.find(d=>d.date===date)?.close ?? null,
          MSTY: MSTY.find(d=>d.date===date)?.close ?? null,
        })).filter(r => r.BTC && r.MSTR && r.MSTY);

        if (!series.length) throw new Error('No overlapping data in chosen window. Try widening dates.');

        // Current prices (last row)
        const last = series[series.length-1];
        $('btcPrice').textContent = fmtUSD.format(last.BTC);
        $('mstrPrice').textContent = fmtUSD.format(last.MSTR);
        $('mstyPrice').textContent = fmtUSD.format(last.MSTY);

        // % from start for MSTR/MSTY
        const first = series[0];
        $('mstrChange').textContent = `% from start: ${((last.MSTR/first.MSTR - 1) * 100).toFixed(2)}%`;
        $('mstyChange').textContent = `% from start: ${((last.MSTY/first.MSTY - 1) * 100).toFixed(2)}%`;

        // BTC 24h change (best effort)
        try {
          const btc24 = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true').then(r=>r.json());
          const ch = btc24.bitcoin.usd_24h_change / 100;
          $('btcChange').textContent = `24h: ${fmtPct(ch)}`;
        } catch {}

        // Build portfolio with monthly DCA on first trading day each month
        const months = monthDiff(new Date(series[0].date), new Date(series[series.length-1].date)) + 1;
        const monthStartSet = new Set();
        series.forEach(r => { const d = new Date(r.date); if (d.getDate()===1) monthStartSet.add(r.date); });

        let units = { BTC: 0, MSTR: 0, MSTY: 0 };
        const initialBuy = startCapital;
        units.BTC += (initialBuy * allocs.BTC) / series[0].BTC;
        units.MSTR += (initialBuy * allocs.MSTR) / series[0].MSTR;
        units.MSTY += (initialBuy * allocs.MSTY) / series[0].MSTY;

        const portVals = [];
        const dailyReturns = [];
        let prevVal = null;

        for (const row of series) {
          const isMonthStart = monthStartSet.has(row.date) && row.date !== series[0].date;
          if (isMonthStart && monthlyDca > 0) {
            units.BTC += (monthlyDca * allocs.BTC) / row.BTC;
            units.MSTR += (monthlyDca * allocs.MSTR) / row.MSTR;
            units.MSTY += (monthlyDca * allocs.MSTY) / row.MSTY;
          }
          const value = units.BTC*row.BTC + units.MSTR*row.MSTR + units.MSTY*row.MSTY;
          portVals.push({ date: row.date, value });
          if (prevVal != null) dailyReturns.push((value/prevVal)-1);
          prevVal = value;
        }

        // KPIs
        const finalVal = portVals[portVals.length-1].value;
        $('finalValue').textContent = fmtUSD.format(finalVal);

        const years = (new Date(series[series.length-1].date) - new Date(series[0].date)) / (365.25*24*3600*1000);
        const totalContribs = startCapital + monthlyDca * (months-1);
        const cagrVal = Math.pow(finalVal/Math.max(1,totalContribs), 1/Math.max(0.0001,years)) - 1;
        $('cagr').textContent = fmtPct(cagrVal);

        const mdd = maxDrawdown(portVals.map(p=>p.value));
        $('mdd').textContent = fmtPct(mdd);

        const vol = annualizedVol(dailyReturns);
        $('vol').textContent = fmtPct(vol);

        const sh = sharpe(dailyReturns, 0);
        $('sharpe').textContent = isFinite(sh) ? sh.toFixed(2) : '—';

        // Chart
        renderChart(portVals);

        // Exports
        window.__beacon_export_rows = [['date','portfolio_value_usd'], ...portVals.map(r=>[r.date, r.value.toFixed(2)])];

        // Live update shocked labels
        const updateShockedLabels = () => {
          $('shockBTCVal').textContent = $('shockBTC').value;
          $('shockMSTRVal').textContent = $('shockMSTR').value;
          $('shockMSTYVal').textContent = $('shockMSTY').value;
        };
        ['shockBTC','shockMSTR','shockMSTY'].forEach(id => $(id).oninput = updateShockedLabels);
        updateShockedLabels();

      } catch (err) {
        alert(err.message || String(err));
      }
    }

    // ====== Chart ======
    let chart;
    function renderChart(data) {
      const ctx = $('chart').getContext('2d');
      const labels = data.map(d=>d.date);
      const values = data.map(d=>d.value);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Portfolio Value (USD)',
            data: values,
            borderWidth: 2,
            tension: 0.25,
            pointRadius: 0
          }]
        },
        options: {
          animation: { duration: 400 },
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { ticks: { color: '#aaa', callback: v => '$'+Intl.NumberFormat('en-US').format(v) }, grid: { color: 'rgba(255,255,255,0.06)' } }
          },
          plugins: {
            legend: { labels: { color: '#ddd' } },
            tooltip: { callbacks: { label: ctx => fmtUSD.format(ctx.parsed.y) } }
          }
        }
      });
    }

    // ====== Events ======
    $('runBtn').addEventListener('click', runSimulation);
    $('resetBtn').addEventListener('click', () => { window.location.reload(); });
    $('csvBtn').addEventListener('click', () => {
      if (!window.__beacon_export_rows) return alert('Run a simulation first.');
      csvDownload('beacon_portfolio.csv', window.__beacon_export_rows);
    });
    $('pngBtn').addEventListener('click', () => {
      if (!chart) return alert('Run a simulation first.');
      const url = chart.toBase64Image('image/png', 1);
      const a = document.createElement('a'); a.href = url; a.download = 'beacon_chart.png'; a.click();
    });
  </script>
</body>
</html>
